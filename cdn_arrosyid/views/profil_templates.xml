<?xml version='1.0' encoding='utf-8'?>
<odoo>
    <template id="profil" inherit_id="portal.portal_my_home" name="profil">
        <xpath expr="//div[hasclass('o_portal_my_home')]" position="inside">
            <style>
                .o_portal_my_home {
                    display: none;
                }
            </style>
        </xpath>
        <xpath expr="//div[hasclass('o_portal_my_home')]" position="after">
            <div class="container-fluid">
                <!-- <h2 t-esc="data_user.name" class="my-4"/> -->
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" data-bs-toggle="tab" href="#identitas" aria-selected="true" role="tab">Identitas</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" data-bs-toggle="tab" href="#pendaftaran" aria-selected="false" tabindex="-1" role="tab">Pendaftaran</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" data-bs-toggle="tab" href="#sesi" aria-selected="false" tabindex="-1" role="tab">Sesi dan Rencana Perjalanan</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" data-bs-toggle="tab" href="#tagihan" aria-selected="false" tabindex="-1" role="tab">Tagihan</a>
                    </li>
                </ul>
                <div id="myTabContent" class="tab-content m-2 ml-3">
                    <div class="tab-pane fade show active" id="identitas" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th scope="col">Nama Jamaah</th>
                                            <th scope="col">Jenis Kelamin</th>
                                            <th scope="col">Paspor</th>
                                            <th scope="col">Tanggal Umroh</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="data_jamaah_umroh" t-as="jamaah">
                                        <tr>
                                            <t t-foreach="jamaah.partner_id" t-as="data">
                                                <td t-esc="data.name"/>
                                            </t>
                                            <td t-esc="jamaah.jenis_kel"/>
                                            <td t-esc="jamaah.paspor"/>
                                            <td t-esc="jamaah.tanggal_umroh"/>
                                        </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                    </div>
                    <div class="tab-pane fade" id="pendaftaran" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th scope="col">Nama Jamaah</th>
                                            <th scope="col">Nama Sesi</th>
                                            <th scope="col">Tanggal Berangkat</th>
                                            <th scope="col">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="data_pendaftaran" t-as="pendaftaran">
                                        <tr>
                                            <t t-foreach="pendaftaran.jamaah_id" t-as="jamaah">
                                                <td t-esc="jamaah.name"/>
                                            </t>
                                            <td t-esc="pendaftaran.name_sesi"/>
                                            <td t-esc="pendaftaran.tanggal_berangkat"/>
                                            <td t-esc="pendaftaran.state"/>
                                        </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                    </div>
                    <div class="tab-pane fade" id="sesi">
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th scope="col">Nama Sesi</th>
                                        <th scope="col">Keterangan</th>
                                        <th scope="col">Tanggal Mulai</th>
                                        <th scope="col">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="data_sesi" t-as="sesi">
                                    <tr>
                                        <td t-esc="sesi.name"/>
                                        <td t-esc="sesi.keterangan"/>
                                        <td t-esc="sesi.tanggal_berangkat"/>
                                        <td class="badge rounded-pill text-bg-primary" t-esc="sesi.state"/>
                                    </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="tagihan">
                        <t t-set="total_residual" t-value="0"/>
                        <t t-foreach="data_tagihan" t-as="tagihan_input">
                            <t t-set="total_residual" t-value="total_residual + tagihan_input.amount_residual"/>
                            <t t-set="data_partner_id" t-value="tagihan_input.partner_id.id"/>
                        </t>
                        <t t-set="formatted_residual" t-value="'{:,.0f}'.format(total_residual).replace(',', '.')"/>
                        <h5>Total tagihan : Rp <t t-esc="formatted_residual"/></h5>
                        <div class="btn-group m-2">
                            <button type="button" class="btn btn-success m-1" data-bs-toggle="modal" data-bs-target="#crt_payment">Bayar</button>
                            <button type="button" class="btn btn-outline-success m-1" data-bs-toggle="modal" data-bs-target="#riwayat_pembayaran">Riwayat Pembayaran</button>
                        </div>
                        <div class="modal fade" id="crt_payment" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLabel">Buat Pembayaran</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div id="loading_pembayaran" class="text-center p-2" style="display: none;">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="sr-only">Loading...</span>
                                            </div>
                                            <div>Mohon tunggu...</div>
                                        </div>
                                        <t t-set="csrf_token" t-value="request.csrf_token()"/>
                                        <form class="row">
                                            <input type="hidden" name="csrf_token" t-att-value="csrf_token" hidden="1"/>
                                            <input type="id" id="dt_partner_id" t-att-value="data_partner_id" hidden="1"/>
                                            <div class="col-6 mb-3">
                                                <label for="metode_bayar" class="form-label">Metode Pembayaran</label>
                                                <select id="metode_bayar" class="form-select"  required="1">
                                                    <option selected="1" disabled="1">pilih metode</option>
                                                    <option value="7">bank</option>
                                                    <option value="6">tunai</option>
                                                </select>
                                            </div>
                                            <div class="col-6 mb-3">
                                                <label for="jml_uang" class="form-label">Jumlah Uang</label>
                                                <input type="text" class="form-control" id="jml_pembayaran"  required="1"/>
                                            </div>
                                            <div class="col-6 mb-3">
                                                <label for="tagihan" class="form-label">Tagihan</label>
                                                <select id="tagihan_id" class="form-select"  required="1">
                                                    <option selected="1" disabled="1">pilih tagihan</option>
                                                    <t t-foreach="data_tagihan" t-as="tagihan_input">
                                                        <t t-if="'INV' in tagihan_input.name and tagihan_input.amount_residual != 0">
                                                            <option t-att-value="tagihan_input.id"><t t-esc="tagihan_input.partner_id.name"/> {<t t-esc="tagihan_input.name"/>} - <t t-esc="tagihan_input.amount_residual"/></option>
                                                        </t>
                                                    </t>
                                                </select>
                                            </div>
                                            <div class="col-6 mb-3">
                                                <label for="tgl_pembayaran" class="form-label">Tangal Pembayaran</label>
                                                <input type="date" class="form-control" id="tgl_pembayaran" required="1"/>
                                            </div>                                       
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-daner" data-bs-dismiss="modal">batal</button>
                                        <button type="submit" id="btn_submit_pembayaran" class="btn btn-success">Bayar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal fade" id="riwayat_pembayaran" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLabel">Riwayat Pembayaran</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">                                        
                                        <table class="table">
                                            <tr>
                                                <th>Nama Prefix</th>
                                                <th>Tanggal Pembayaran</th>
                                                <th>Jumlah (Rp)</th>
                                                <th>Mode pembayaran</th>
                                                <th>Tujuan Tagihan</th>
                                            </tr>
                                            <t t-foreach="data_tagihan" t-as="tagihan">
                                                <t t-if="'INV' not in tagihan.name">
                                                    <tr>
                                                        <td>
                                                            <t t-esc="tagihan.name"/>
                                                        </td>
                                                        <td>
                                                            <t t-esc="tagihan.date"/>
                                                        </td>
                                                        <td>
                                                            Rp <t t-esc="'{:,.0f}'.format(tagihan.amount_total).replace(',', '.')"/>
                                                        </td>
                                                        <td>
                                                            <t t-if="'PBNK' in tagihan.name">
                                                                Bank
                                                            </t>
                                                            <t t-elif=" 'PCSH' in tagihan.name">
                                                                Tunai
                                                            </t>
                                                            <t t-else="">
                                                                data tidak valid
                                                            </t>
                                                        </td>
                                                        <td>
                                                            <t t-esc="tagihan.ref"/>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </t>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <table class="table">
                            <tr>
                                <th>Nama</th>
                                <th>Tanggal tagihan</th>
                                <th>Tagihan (Rp)</th>
                                <th>Status pembayaran</th>
                                <th>...</th>
                            </tr>
                            <t t-foreach="data_tagihan" t-as="tagihan">
                                <t t-if="'INV' in tagihan.name">
                                    <tr>
                                        <td>
                                            <t t-esc="tagihan.partner_id.name"/> {<t t-esc="tagihan.name"/>}
                                        </td>
                                        <td>
                                            <t t-esc="tagihan.invoice_date"/>
                                        </td>
                                        <td>
                                            Rp <t t-esc="'{:,.0f}'.format(tagihan.amount_residual).replace(',', '.')"/>
                                        </td>
                                        <td>
                                            <t t-set="payment_state_label">
                                                <t t-raw="{
                                                    'partial': 'sebagian',
                                                    'paid': 'lunas'
                                                }.get(tagihan.payment_state, 'belum lunas')"/>
                                            </t>
                                            <t t-esc="payment_state_label"/>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group" aria-label="Basic example">
                                                <button type="button" class="btn btn-outline-success btn_detail_tagihan" t-att-data-dt_tagihan_id="tagihan.id" t-att-data-dt_nm_user="tagihan.partner_id.name">  lihat detail </button>
                                            </div>
                                        </td>
                                    </tr>
                                </t>
                            </t>
                        </table>
                    </div>

                </div>
            </div>
        </xpath>
    </template>
</odoo>
